<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Dolivar - Calculadora BCV Profesional</title>
    
    <!-- ‚úÖ Nombre y descripci√≥n obligatorios para PWABuilder -->
    <meta name="name" content="Dolivar">
    <meta name="description" content="Calculadora inteligente para sumar y convertir precios en d√≥lares (US$), euros (‚Ç¨) y bol√≠vares (Bs) al instante.">
    
    <!-- Configuraci√≥n PWA -->
    <meta name="theme-color" content="#7D1935">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- √çcono PWA -->
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiB2aWV3Qm94PSIwIDAgNTEyIDUxMiI+PHJlY3Qgd2lkdGg9IjUxMiIgaGVpZ2h0PSI1MTIiIGZpbGw9IiMxZTI5M2IiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iI2Y4ZmFmYyIgZm9udC1zaXplPSIxMzAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC13ZWlnaHQ9ImJvbGQiPlVTJMKgL0JzPC90ZXh0Pjwvc3ZnPg==">

    <!-- ‚úÖ Manifest f√≠sico (NO en base64) -->
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-body: #94a3b8;
            --bg-calc: #475569; 
            --text-main: #f8fafc;
            --bg-display: #0f172a;
            --bg-btn-num: #cbd5e1;
            --text-btn-num: #0f172a;
            --bg-btn-op: #94a3b8;
            --text-btn-op: #0f172a;
            --border-btn: #334155;
            --bg-modal: rgba(255, 255, 255, 0.95);
            --text-modal: #0f172a;
        }

        .dark-mode {
            --bg-body: #020617;
            --bg-calc: #1e293b;
            --text-main: #f8fafc;
            --bg-display: #020617;
            --bg-btn-num: #334155;
            --text-btn-num: #f8fafc;
            --bg-btn-op: #475569;
            --text-btn-op: #f1f5f9;
            --border-btn: #475569;
            --bg-modal: rgba(30, 41, 59, 0.95);
            --text-modal: #f8fafc;
        }

        body {
            background-color: var(--bg-body);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100dvh;
            margin: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            transition: all 0.3s ease;
            touch-action: manipulation;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        .calc-container {
            width: 100%;
            max-width: 400px;
            background-color: var(--bg-calc);
            border-radius: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            padding: 1.25rem;
            border: 1.5px solid var(--border-btn);
            position: relative;
            max-height: 95dvh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .rate-top-bar {
            text-align: center;
            margin-bottom: 0.8rem;
            padding: 0.5rem;
            background: rgba(15, 23, 42, 0.3);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .display-area {
            background-color: var(--bg-display);
            border-radius: 1.75rem;
            padding: 1.1rem 1.3rem;
            margin-bottom: 1.2rem;
            text-align: right;
            color: white;
            min-height: 130px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        .btn {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 64px;
            border-radius: 1.15rem;
            font-size: 1.45rem;
            font-weight: 700;
            transition: all 0.1s ease;
            cursor: pointer;
            user-select: none;
            border-bottom: 3px solid var(--border-btn);
        }

        .btn:active { transform: translateY(2px); border-bottom-width: 1px; }

        .btn-number { background-color: var(--bg-btn-num); color: var(--text-btn-num); }
        .btn-op { background-color: var(--bg-btn-op); color: var(--text-btn-op); }
        .btn-eq { background-color: #2563eb; color: #ffffff; border-bottom-color: #1d4ed8; }
        .btn-clear { background-color: #be123c; color: #ffffff; border-bottom-color: #881337; }
        .btn-del { background-color: #f59e0b; color: #ffffff; border-bottom-color: #b45309; }

        .btn-op, .btn-eq {
            border-bottom: 4px solid var(--border-btn);
            font-weight: 800;
        }
        .btn-op:active, .btn-eq:active {
            transform: translateY(3px);
            border-bottom-width: 1px;
        }

        .dark-mode .btn-op,
        .dark-mode .btn-eq {
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        .control-icon {
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            flex-shrink: 0;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .control-icon:hover { color: #f1f5f9; background: rgba(255, 255, 255, 0.2); }
        .control-icon svg { width: 20px; height: 20px; display: block; }

        .settings-modal, .help-modal, .about-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 80%;
            background: var(--bg-modal);
            backdrop-filter: blur(10px);
            border-radius: 2rem;
            padding: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 50;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-modal);
            text-align: center;
        }
        .settings-modal.active, .help-modal.active, .about-modal.active {
            display: block;
            animation: modalIn 0.2s forwards;
        }
        
        @keyframes modalIn {
            to { transform: translate(-50%, -50%) scale(1); }
        }

        .modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            border-radius: 2.5rem;
            display: none;
            z-index: 40;
        }
        .modal-overlay.active { display: block; }

        #rate-label { cursor: pointer; font-size: 13px; display: block; }
        #date-label { font-size: 10px; color: #94a3b8; font-weight: 500; }
        .rate-value { color: #60a5fa; font-weight: 900; }
        .loading-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        #operation-history {
            font-family: 'JetBrains Mono', monospace;
            min-height: 1.5rem;
            opacity: 0.8;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: none;
            flex-grow: 1;
            text-align: right;
            padding-left: 8px;
            margin-left: 8px;
            max-width: calc(100% - 50px);
            font-size: 1.15rem; /* ‚úÖ Fuente m√°s grande en historial */
        }
        #operation-history::-webkit-scrollbar {
            display: none;
        }
        
        .modal-content {
            text-align: left;
            font-size: 0.9rem;
            line-height: 1.5;
            max-height: 220px;
            overflow-y: auto;
        }
        .highlight {
            background: rgba(0,0,0,0.05);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-weight: bold;
            display: inline-block;
            margin: 0.2rem 0;
        }

        #main-display {
            font-size: 1.75rem;
            font-weight: 900;
            letter-spacing: -0.025em;
            color: white;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            line-height: 1.25;
        }

        #converted-display {
            color: #60a5fa;
            font-size: 1.05rem;
            font-weight: 700;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
        }

        .grid-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.75rem;
            flex-grow: 1;
        }

        /* Estilo para sliders */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #d1d5db;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #7D1935;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Men√∫ emergente para selector de moneda */
        #currency-menu {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-modal);
            color: var(--text-modal);
            border-radius: 1rem;
            padding: 0.5rem 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 60;
            display: none;
            width: 140px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        #currency-menu button {
            display: block;
            width: 100%;
            padding: 0.5rem;
            background: none;
            border: none;
            color: var(--text-modal);
            text-align: center;
            font-size: 0.95rem;
            cursor: pointer;
        }
        #currency-menu button:hover {
            background: rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<div class="calc-container">
    <div id="modal-overlay" class="modal-overlay" onclick="closeAllModals()"></div>
    
    <!-- Modal de Configuraci√≥n -->
    <div id="settings-modal" class="settings-modal">
        <h3 class="font-bold text-lg mb-4">Configuraci√≥n</h3>
        <div class="flex flex-col gap-4">
            <div class="flex items-center justify-between p-3 bg-black/10 rounded-xl cursor-pointer" onclick="toggleTheme()">
                <span>Modo Oscuro/Claro</span>
                <div class="control-icon">
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z" />
                    </svg>
                    <svg id="moon-icon" style="display: none;" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                </div>
            </div>

            <!-- Control de Volumen -->
            <div class="p-3 bg-black/10 rounded-xl">
                <div class="flex justify-between items-center mb-2">
                    <span>üîä Volumen</span>
                    <span id="volume-value">100%</span>
                </div>
                <input type="range" id="volume-slider" min="0" max="100" value="100" 
                       class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
            </div>

            <!-- Control de Vibraci√≥n -->
            <div class="p-3 bg-black/10 rounded-xl">
                <div class="flex justify-between items-center mb-2">
                    <span>üì≥ Vibraci√≥n</span>
                    <span id="vibration-value">100 ms</span>
                </div>
                <input type="range" id="vibration-slider" min="0" max="150" value="100" 
                       class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
            </div>

            <div class="p-3 bg-black/10 rounded-xl cursor-pointer" onclick="showHelp()">
                <span>Ayuda</span>
            </div>
            <div class="p-3 bg-black/10 rounded-xl cursor-pointer" onclick="showAbout()">
                <span>Acerca de</span>
            </div>
            <button class="mt-4 p-3 bg-blue-600 text-white rounded-xl font-bold" onclick="closeAllModals()">Cerrar</button>
        </div>
    </div>

    <!-- Modal de Ayuda -->
    <div id="help-modal" class="help-modal">
        <h3 class="font-bold text-lg mb-3">Ayuda</h3>
        <div class="modal-content">
            <p><strong>Dolivar</strong></p>
            <ul>
                <li>‚úÖ <strong>Soporta USD, EUR y Bs</strong>: opera en las tres monedas oficiales.</li>
                <li>‚úÖ <strong>Respeta la l√≥gica del abasto</strong>: mezcla precios en d√≥lares, euros y bol√≠vares.</li>
                <li>‚úÖ <strong>Interpreta correctamente las cantidades</strong>: <code>√ó3</code>, <code>/2</code> sin moneda, porque son unidades, no montos.</li>
                <li>‚úÖ <strong>Calcula con jerarqu√≠a matem√°tica</strong>: multiplicaci√≥n y divisi√≥n antes que suma y resta.</li>
                <li>‚úÖ <strong>Muestra resultados confiables</strong>: ya sea en USD, EUR o Bs, seg√∫n lo necesites.</li>
            </ul>
            <p>Esto no es solo una calculadora: es una <strong>herramienta de toma de decisiones diarias</strong> para quienes viven y compran en un entorno trimonetario.</p>
            <p class="font-bold mt-3">Gu√≠a de Uso</p>
            <ul>
                <li>üîπ <strong>Conversi√≥n en Tiempo Real</strong>: Al introducir un monto, la calculadora muestra autom√°ticamente la equivalencia en las otras monedas bas√°ndose en las tasas oficiales.</li>
                <li>üîπ <strong>Cambio de Moneda</strong>: Mant√©n presionado el bot√≥n del selector durante 2 segundos para alternar entre USD y EUR.</li>
                <li>üîπ <strong>Jerarqu√≠a Matem√°tica</strong>: El sistema procesa primero multiplicaciones/divisiones y luego sumas/restas, garantizando resultados exactos en operaciones complejas.</li>
                <li>üîπ <strong>Tasas BCV y EUR</strong>: Los datos se sincronizan con APIs oficiales. Puedes forzar una actualizaci√≥n tocando la barra superior.</li>
                <li>üîπ <strong>Historial</strong>: En la parte superior de la pantalla de visualizaci√≥n, ver√°s la secuencia de tu operaci√≥n actual.</li>
            </ul>
        </div>
        <button class="mt-4 p-3 bg-blue-600 text-white rounded-xl font-bold" onclick="closeAllModals()">Cerrar</button>
    </div>

    <!-- Modal de Acerca de -->
    <div id="about-modal" class="about-modal">
        <h3 class="font-bold text-lg mb-3">Acerca de</h3>
        <div class="modal-content text-center">
            <p class="highlight">DOLIVAR v1.2.6 ‚Äî 22/01/2026</p>
            <p class="mt-4">Desarrollador Principal</p>
            <p>Magdiel Mendoza</p>
            <p class="mt-4">"Esta aplicaci√≥n fue realizada con la ayuda de <strong>Qwen AI</strong> y <strong>Gemini AI</strong> para ofrecer una herramienta profesional y precisa al p√∫blico venezolano."</p>
            <p class="mt-4">‚òï Esta es una herramienta gratuita. Si te ha sido de utilidad, ¬°acepto donaciones! (Aunque no tomo caf√©, tu donaci√≥n es como si me invitaras un caf√©, un gesto siempre se agradece).</p>
        </div>
        <button class="mt-4 p-3 bg-blue-600 text-white rounded-xl font-bold" onclick="closeAllModals()">Cerrar</button>
    </div>

    <div class="rate-top-bar transition-colors" onclick="fetchBCVRates()">
        <span id="rate-label" class="loading-pulse uppercase tracking-[0.05em] text-slate-100 font-bold">
            Sincronizando tasas...
        </span>
        <span id="date-label"></span>
    </div>

    <div class="display-area">
        <div class="flex justify-between items-center mb-1 w-full overflow-hidden">
            <div class="control-icon" onclick="toggleSettings()" title="Configuraci√≥n">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                </svg>
            </div>
            <div id="operation-history" class="text-slate-400 text-sm font-medium tracking-wide"></div>
        </div>
        
        <div class="flex flex-col gap-1">
            <div id="main-display">$ 0</div>
            <div id="converted-display">Bs. 0,00</div>
        </div>
    </div>

    <div class="grid-buttons">
        <div class="btn btn-clear" onclick="clearDisplay()">AC</div>
        <div class="btn btn-del" onclick="deleteLast()">Del</div>
        <div class="btn btn-op relative" id="currency-btn" style="font-size: 1.4rem; font-weight: 800;">
            <span id="currency-symbol">US$</span>
            <div id="currency-menu">
                <button data-mode="usd">US$/Bs</button>
                <button data-mode="eur">Euro/Bs</button>
            </div>
        </div>
        <div class="btn btn-op" onclick="setOperator('/')">√∑</div>

        <div class="btn btn-number" onclick="addNum('7')">7</div>
        <div class="btn btn-number" onclick="addNum('8')">8</div>
        <div class="btn btn-number" onclick="addNum('9')">9</div>
        <div class="btn btn-op" onclick="setOperator('*')">√ó</div>

        <div class="btn btn-number" onclick="addNum('4')">4</div>
        <div class="btn btn-number" onclick="addNum('5')">5</div>
        <div class="btn btn-number" onclick="addNum('6')">6</div>
        <div class="btn btn-op" onclick="setOperator('-')">‚àí</div>

        <div class="btn btn-number" onclick="addNum('1')">1</div>
        <div class="btn btn-number" onclick="addNum('2')">2</div>
        <div class="btn btn-number" onclick="addNum('3')">3</div>
        <div class="btn btn-op" onclick="setOperator('+')">+</div>

        <div class="btn btn-number col-span-2" onclick="addNum('0')">0</div>
        <div class="btn btn-number" onclick="addNum('.')">.</div>
        <div class="btn btn-eq" onclick="calc()">=</div>
    </div>
</div>

<script>
/* 
 * Dolivar - Calculadora BCV Profesional
 * √öltima actualizaci√≥n: 22/01/2026
 * v1.2.6: Selector de moneda con long press + correcci√≥n de API + historial m√°s legible
 */

let currentInputText = '0';
let expressionTokens = [];
let isNewInput = true;
let bcvRate = null;      // Tasa USD/Bs
let eurRate = null;      // Tasa EUR/Bs
let inputCurrency = 'USD'; // Solo 'USD' o 'EUR'
let audioCtx = null;
let lastOperator = null;
let nextNumberIsMultiplier = false;
let volumeLevel = parseFloat(localStorage.getItem('dolivar_volume') || '1.0');
let vibrationDuration = parseInt(localStorage.getItem('dolivar_vibration') || '100');

const mainDisplay = document.getElementById('main-display');
const convertedDisplay = document.getElementById('converted-display');
const opHistoryDisplay = document.getElementById('operation-history');
const rateLabel = document.getElementById('rate-label');
const dateLabel = document.getElementById('date-label');
const settingsModal = document.getElementById('settings-modal');
const helpModal = document.getElementById('help-modal');
const aboutModal = document.getElementById('about-modal');
const modalOverlay = document.getElementById('modal-overlay');
const volumeSlider = document.getElementById('volume-slider');
const vibrationSlider = document.getElementById('vibration-slider');
const volumeValue = document.getElementById('volume-value');
const vibrationValue = document.getElementById('vibration-value');
const currencyBtn = document.getElementById('currency-btn');
const currencyMenu = document.getElementById('currency-menu');
const currencySymbol = document.getElementById('currency-symbol');

if (volumeSlider) {
    volumeSlider.value = Math.round(volumeLevel * 100);
    volumeValue.textContent = Math.round(volumeLevel * 100) + '%';
}
if (vibrationSlider) {
    vibrationSlider.value = vibrationDuration;
    vibrationValue.textContent = vibrationDuration + ' ms';
}

if (vibrationSlider) {
    vibrationSlider.addEventListener('input', () => {
        vibrationDuration = parseInt(vibrationSlider.value);
        vibrationValue.textContent = vibrationDuration + ' ms';
        localStorage.setItem('dolivar_vibration', vibrationDuration.toString());
        if (navigator.vibrate && vibrationDuration > 0) navigator.vibrate(50);
    });
}
if (volumeSlider) {
    volumeSlider.addEventListener('input', () => {
        volumeLevel = parseFloat(volumeSlider.value) / 100;
        volumeValue.textContent = volumeSlider.value + '%';
        localStorage.setItem('dolivar_volume', volumeLevel.toString());
        playSoundPreview();
    });
}

function playSoundPreview() {
    if (volumeLevel <= 0) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.frequency.setValueAtTime(600, audioCtx.currentTime);
    gain.gain.setValueAtTime(volumeLevel * 0.1, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.15);
    osc.start(); osc.stop(audioCtx.currentTime + 0.15);
}

function playSound(type) {
    if (volumeLevel <= 0) return;
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    const oscillator = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    oscillator.connect(gainNode); gainNode.connect(audioCtx.destination);
    let freq;
    switch(type) {
        case 'num': freq = 600; break;
        case 'eq': freq = 750; break;
        case 'clear': freq = 180; break;
        default: freq = 450;
    }
    oscillator.type = 'sine';
    oscillator.frequency.setValueAtTime(freq, audioCtx.currentTime);
    gainNode.gain.setValueAtTime(volumeLevel * 0.12, audioCtx.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
    oscillator.start();
    oscillator.stop(audioCtx.currentTime + 0.2);
}

function vibrate() {
    if (vibrationDuration > 0 && navigator.vibrate) {
        navigator.vibrate(vibrationDuration);
    }
}

function provideFeedback(type = 'op') {
    vibrate();
    playSound(type);
}

function toggleSettings() {
    provideFeedback('op');
    settingsModal.classList.add('active');
    modalOverlay.classList.add('active');
}

function closeAllModals() {
    settingsModal.classList.remove('active');
    helpModal.classList.remove('active');
    aboutModal.classList.remove('active');
    modalOverlay.classList.remove('active');
    currencyMenu.style.display = 'none';
}

function showHelp() {
    settingsModal.classList.remove('active');
    helpModal.classList.add('active');
}

function showAbout() {
    settingsModal.classList.remove('active');
    aboutModal.classList.add('active');
}

function initTheme() {
    const savedTheme = localStorage.getItem('calc-theme');
    const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
    if (isDark) {
        document.body.classList.add('dark-mode');
        document.getElementById('sun-icon').style.display = 'block';
        document.getElementById('moon-icon').style.display = 'none';
    } else {
        document.getElementById('sun-icon').style.display = 'none';
        document.getElementById('moon-icon').style.display = 'block';
    }
}

function toggleTheme() {
    provideFeedback('op');
    const isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('calc-theme', isDark ? 'dark' : 'light');
    if (isDark) {
        document.getElementById('sun-icon').style.display = 'block';
        document.getElementById('moon-icon').style.display = 'none';
    } else {
        document.getElementById('sun-icon').style.display = 'none';
        document.getElementById('moon-icon').style.display = 'block';
    }
}

// ‚úÖ Nueva funci√≥n: obtiene tasas de USD y EUR con fallback correcto
async function fetchBCVRates() {
    rateLabel.innerHTML = "Sincronizando tasas...";
    dateLabel.innerHTML = "";
    rateLabel.classList.add('loading-pulse');
    
    // Intento 1: API principal (dolarvzla.com)
    try {
        const response1 = await fetch("https://api.dolarvzla.com/public/exchange-rate");
        if (response1.ok) {
            const data1 = await response1.json();
            if (data1 && data1.current && typeof data1.current.usd === 'number' && typeof data1.current.eur === 'number') {
                bcvRate = parseFloat(data1.current.usd);
                eurRate = parseFloat(data1.current.eur);
                saveRatesToStorage(bcvRate, eurRate, data1.current.date);
                displayRates();
                return;
            }
        }
    } catch (e1) {
        console.warn("API principal fall√≥:", e1);
    }

    // Intento 2: API de respaldo (ve.dolarapi.com) ‚Äî solo para USD
    try {
        const response2 = await fetch("https://ve.dolarapi.com/v1/dolares");
        if (response2.ok) {
            const data2 = await response2.json();
            const oficial = data2.find(d => d.nombre?.toLowerCase().includes('oficial'));
            if (oficial && oficial.promedio) {
                bcvRate = parseFloat(oficial.promedio);
                // No hay EUR en esta API ‚Üí mantener eurRate anterior si existe, o usar proporci√≥n
                if (!eurRate) {
                    eurRate = bcvRate * 1.17; // estimaci√≥n conservadora
                }
                saveRatesToStorage(bcvRate, eurRate, new Date().toISOString().split('T')[0]);
                displayRates();
                return;
            }
        }
    } catch (e2) {
        console.warn("API de respaldo fall√≥:", e2);
    }

    // Intento 3: Usar √∫ltimas tasas guardadas
    const lastUSD = localStorage.getItem('dolivar_last_usd_rate');
    const lastEUR = localStorage.getItem('dolivar_last_eur_rate');
    if (lastUSD && lastEUR) {
        bcvRate = parseFloat(lastUSD);
        eurRate = parseFloat(lastEUR);
        updateUI();
        rateLabel.innerHTML = `TASAS ANTERIORES`;
        dateLabel.innerHTML = "√öltima actualizaci√≥n guardada";
        rateLabel.classList.remove('loading-pulse');
        return;
    }

    // ‚ùå Todas fallaron
    rateLabel.innerText = "‚ö†Ô∏è Error de red. Reintentar";
    rateLabel.classList.remove('loading-pulse');
}

// Guardar tasas en localStorage
function saveRatesToStorage(usd, eur, date) {
    localStorage.setItem('dolivar_last_usd_rate', usd.toString());
    localStorage.setItem('dolivar_last_eur_rate', eur.toString());
    localStorage.setItem('dolivar_last_date', date);
}

// Mostrar tasas en UI
function displayRates() {
    if (!bcvRate || !eurRate) return;
    
    const usdFormatted = bcvRate.toLocaleString('de-DE', {minimumFractionDigits: 2});
    const eurFormatted = eurRate.toLocaleString('de-DE', {minimumFractionDigits: 2});
    rateLabel.innerHTML = `USD: <span class="rate-value">${usdFormatted}</span> | EUR: <span class="rate-value">${eurFormatted}</span> Bs`;
    
    const dateStr = localStorage.getItem('dolivar_last_date') || new Date().toISOString();
    const d = new Date(dateStr);
    const fechaFinal = `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
    dateLabel.innerHTML = `TASAS ACTUALIZADAS AL: ${fechaFinal}`;
    
    rateLabel.classList.remove('loading-pulse');
    updateUI();
}

// ‚úÖ Nuevo selector con long press
let longPressTimer = null;

currencyBtn.addEventListener('mousedown', startLongPress);
currencyBtn.addEventListener('mouseup', endLongPress);
currencyBtn.addEventListener('mouseleave', endLongPress);
currencyBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startLongPress(); });
currencyBtn.addEventListener('touchend', endLongPress);

function startLongPress() {
    longPressTimer = setTimeout(() => {
        currencyMenu.style.display = 'block';
    }, 2000);
}

function endLongPress() {
    clearTimeout(longPressTimer);
}

// Selecci√≥n en men√∫
currencyMenu.querySelectorAll('button').forEach(btn => {
    btn.addEventListener('click', () => {
        const newMode = btn.dataset.mode;
        setCurrencyMode(newMode);
        currencyMenu.style.display = 'none';
    });
});

function setCurrencyMode(mode) {
    provideFeedback('op');
    if (!bcvRate || !eurRate) {
        alert("‚ö†Ô∏è Primero sincroniza las tasas.");
        return;
    }

    let currentVal = parseFloat(currentInputText.replace(/,/g, '')) || 0;

    if (mode === 'usd' && inputCurrency !== 'USD') {
        // Convertir desde EUR o BS a USD
        if (inputCurrency === 'EUR') {
            currentVal = currentVal * eurRate / bcvRate;
        } else { // BS
            currentVal = currentVal / bcvRate;
        }
        inputCurrency = 'USD';
        currencySymbol.textContent = 'US$';
    } else if (mode === 'eur' && inputCurrency !== 'EUR') {
        // Convertir desde USD o BS a EUR
        if (inputCurrency === 'USD') {
            currentVal = currentVal * bcvRate / eurRate;
        } else { // BS
            currentVal = currentVal / eurRate;
        }
        inputCurrency = 'EUR';
        currencySymbol.textContent = '‚Ç¨';
    }

    currentInputText = currentVal.toFixed(2);
    if (currentInputText.endsWith('.00')) {
        currentInputText = parseInt(parseFloat(currentInputText)).toString();
    }

    updateUI();
}

function updateUI() {
    let prefix, convertedText;
    
    // Determinar prefijo y valor principal
    if (inputCurrency === 'USD') {
        prefix = '$ ';
    } else if (inputCurrency === 'EUR') {
        prefix = '‚Ç¨ ';
    }

    let displayVal = currentInputText;
    const numValue = parseFloat(currentInputText.replace(/,/g, '')) || 0;

    if (Math.abs(numValue) >= 1e10) {
        displayVal = numValue.toExponential(5).replace(/e\+?/, 'e');
    } else if (currentInputText !== '0') {
        const parts = currentInputText.split('.');
        const integerPart = parseInt(parts[0]).toLocaleString('de-DE');
        displayVal = parts.length > 1 ? integerPart + ',' + parts[1] : integerPart;
    } else {
        displayVal = "0";
    }

    mainDisplay.innerText = prefix + displayVal;

    // Calcular valor convertido
    if (bcvRate && eurRate) {
        let val = parseFloat(currentInputText.replace(/,/g, '')) || 0;
        if (inputCurrency === 'USD') {
            convertedText = `Bs. ${(val * bcvRate).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} | ‚Ç¨ ${(val * bcvRate / eurRate).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        } else if (inputCurrency === 'EUR') {
            convertedText = `Bs. ${(val * eurRate).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} | $ ${(val * eurRate / bcvRate).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
    } else {
        convertedText = "Tasa no disponible";
    }

    convertedDisplay.innerText = convertedText;
    updateHistory();
    opHistoryDisplay.scrollLeft = opHistoryDisplay.scrollWidth;
}

function updateHistory() {
    let displayParts = [];
    for (let token of expressionTokens) {
        if (typeof token === 'string') {
            displayParts.push(token);
        } else {
            if (token.currency === 'UNIT') {
                displayParts.push(token.value);
            } else {
                const prefix = token.currency === 'USD' ? '$' : token.currency === 'EUR' ? '‚Ç¨' : 'Bs';
                displayParts.push(prefix + token.value);
            }
        }
    }
    if (currentInputText !== '0' || expressionTokens.length === 0) {
        if (nextNumberIsMultiplier) {
            displayParts.push(currentInputText);
        } else {
            const prefix = inputCurrency === 'USD' ? '$' : '‚Ç¨';
            displayParts.push(prefix + currentInputText);
        }
    }
    opHistoryDisplay.innerText = displayParts.join('');
}

function addNum(n) {
    provideFeedback('num');
    if (isNewInput) {
        currentInputText = (n === '.') ? '0.' : n;
        isNewInput = false;
    } else {
        if (n === '.' && currentInputText.includes('.')) return;
        if (currentInputText.includes('.') && currentInputText.split('.')[1].length >= 2) return;
        if (currentInputText === '0' && n !== '.') currentInputText = n;
        else currentInputText += n;
    }
    updateUI();
}

function deleteLast() {
    provideFeedback('op');
    if (isNewInput || currentInputText === '0') return;
    currentInputText = currentInputText.length === 1 ? '0' : currentInputText.slice(0, -1);
    updateUI();
}

function captureCurrentNumber() {
    const token = {
        value: currentInputText,
        currency: nextNumberIsMultiplier ? 'UNIT' : inputCurrency
    };
    nextNumberIsMultiplier = false;
    return token;
}

function setOperator(op) {
    provideFeedback('op');
    if (currentInputText === '0' && expressionTokens.length === 0) return;
    expressionTokens.push(captureCurrentNumber());
    expressionTokens.push(op);
    lastOperator = op;
    nextNumberIsMultiplier = (op === '*' || op === '/');
    isNewInput = true;
    currentInputText = '0';
    updateUI();
}

function evaluateWithPrecedence(tokens, usdRate, eurRate) {
    const workTokens = [...tokens];
    for (let i = 1; i < workTokens.length; i += 2) {
        if (workTokens[i] === '*' || workTokens[i] === '/') {
            const left = workTokens[i - 1];
            const right = workTokens[i + 1];
            let leftUSD = parseFloat(left.value);
            if (left.currency === 'BS') leftUSD /= usdRate;
            else if (left.currency === 'EUR') leftUSD = (leftUSD * eurRate) / usdRate;
            
            const rightNum = parseFloat(right.value);
            const resultUSD = workTokens[i] === '*' 
                ? leftUSD * rightNum 
                : (rightNum === 0 ? 0 : leftUSD / rightNum);
                
            workTokens.splice(i - 1, 3, { value: resultUSD.toString(), currency: 'USD' });
            i -= 2;
        }
    }
    let totalUSD = 0;
    let currentSign = 1;
    for (let i = 0; i < workTokens.length; i++) {
        const token = workTokens[i];
        if (typeof token === 'string') {
            if (token === '+') currentSign = 1;
            else if (token === '-') currentSign = -1;
        } else {
            let val = parseFloat(token.value);
            if (token.currency === 'BS') val /= usdRate;
            else if (token.currency === 'EUR') val = (val * eurRate) / usdRate;
            totalUSD += currentSign * val;
            currentSign = 1;
        }
    }
    return totalUSD;
}

function calc() {
    provideFeedback('eq');
    if (expressionTokens.length === 0) return;
    if (!bcvRate || !eurRate) {
        alert("‚ö†Ô∏è No se han cargado las tasas.");
        return;
    }
    expressionTokens.push(captureCurrentNumber());
    const resultUSD = evaluateWithPrecedence(expressionTokens, bcvRate, eurRate);
    
    if (inputCurrency === 'USD') {
        currentInputText = resultUSD.toFixed(2);
    } else if (inputCurrency === 'EUR') {
        currentInputText = (resultUSD * bcvRate / eurRate).toFixed(2);
    }
    
    if (currentInputText.endsWith('.00')) {
        currentInputText = parseInt(parseFloat(currentInputText)).toString();
    }
    expressionTokens = [];
    lastOperator = null;
    nextNumberIsMultiplier = false;
    isNewInput = true;
    updateUI();
}

function clearDisplay() { 
    provideFeedback('clear'); 
    currentInputText = '0';
    expressionTokens = [];
    lastOperator = null;
    nextNumberIsMultiplier = false;
    isNewInput = true;
    updateUI(); 
}

// Cerrar men√∫ si se hace clic fuera
document.addEventListener('click', (e) => {
    if (!currencyBtn.contains(e.target) && !currencyMenu.contains(e.target)) {
        currencyMenu.style.display = 'none';
    }
});

window.onload = () => { initTheme(); fetchBCVRates(); };
</script>
</body>
</html>
